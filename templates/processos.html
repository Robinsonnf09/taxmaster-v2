{% extends "base.html" %}

{% block title %}Processos - Tax Master{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-4">
            <i class="fas fa-folder-open text-primary"></i>
            Processos e Precatórios
        </h1>
        <p class="lead text-muted">Gestão completa com filtros avançados</p>
    </div>
</div>

<!-- Botões de Ação -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <a href="/buscar-listas-precatorios" class="btn btn-info btn-lg">
            <i class="fas fa-search-plus me-2"></i>
            Buscar nas Listas de Precatórios Pendentes
        </a>
    </div>
    <a href="/processo/cadastrar" class="btn btn-success btn-lg">
        <i class="fas fa-plus-circle me-2"></i>
        Cadastrar Novo Processo
    </a>
</div>

<!-- Filtros Avançados -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="fas fa-filter me-2"></i>
            Filtros Avançados
            <button class="btn btn-sm btn-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosCollapse">
                <i class="fas fa-chevron-down"></i>
            </button>
        </h5>
    </div>
    <div class="collapse show" id="filtrosCollapse">
        <div class="card-body">
            <form method="GET" action="/processos" id="formFiltros">
                <div class="row g-3">
                    
                    <!-- Busca Rápida -->
                    <div class="col-md-12">
                        <label class="form-label">
                            <i class="fas fa-search me-1"></i>
                            <strong>Busca Rápida</strong>
                        </label>
                        <input type="text" class="form-control form-control-lg" 
                               name="busca" 
                               placeholder="Número do processo, credor, advogado..."
                               value="{{ request.args.get('busca', '') }}">
                    </div>
                    
                    <!-- Tribunal -->
                    <div class="col-md-3">
                        <label class="form-label">
                            <i class="fas fa-landmark me-1"></i>
                            <strong>Tribunal</strong>
                        </label>
                        <select class="form-select" name="tribunal" id="filtroTribunal">
                            <option value="">Todos os Tribunais</option>
                            {% for trib in tribunais %}
                            <option value="{{ trib.name }}" 
                                    {% if request.args.get('tribunal') == trib.name %}selected{% endif %}>
                                {{ trib.value }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Esfera -->
                    <div class="col-md-3">
                        <label class="form-label">
                            <i class="fas fa-globe me-1"></i>
                            <strong>Esfera</strong>
                        </label>
                        <select class="form-select" name="esfera" id="filtroEsfera">
                            <option value="">Todas as Esferas</option>
                            <option value="ESTADUAL" {% if request.args.get('esfera') == 'ESTADUAL' %}selected{% endif %}>
                                Estadual
                            </option>
                            <option value="MUNICIPAL" {% if request.args.get('esfera') == 'MUNICIPAL' %}selected{% endif %}>
                                Municipal
                            </option>
                            <option value="FEDERAL" {% if request.args.get('esfera') == 'FEDERAL' %}selected{% endif %}>
                                Federal
                            </option>
                        </select>
                    </div>
                    
                    <!-- Natureza -->
                    <div class="col-md-3">
                        <label class="form-label">
                            <i class="fas fa-tag me-1"></i>
                            <strong>Natureza</strong>
                        </label>
                        <select class="form-select" name="natureza" id="filtroNatureza">
                            <option value="">Todas as Naturezas</option>
                            {% for nat in naturezas %}
                            <option value="{{ nat.name }}" 
                                    {% if request.args.get('natureza') == nat.name %}selected{% endif %}>
                                {{ nat.value }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Status/Fase -->
                    <div class="col-md-3">
                        <label class="form-label">
                            <i class="fas fa-tasks me-1"></i>
                            <strong>Status/Fase</strong>
                        </label>
                        <select class="form-select" name="status" id="filtroStatus">
                            <option value="">Todos os Status</option>
                            {% for st in status_list %}
                            <option value="{{ st.name }}" 
                                    {% if request.args.get('status') == st.name %}selected{% endif %}>
                                {{ st.value }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Ano do Precatório - ATUALIZADO (2022-2026) -->
                    <div class="col-md-2">
                        <label class="form-label">
                            <i class="fas fa-calendar me-1"></i>
                            <strong>Ano do Precatório</strong>
                        </label>
                        <select class="form-select" name="ano_precatorio" id="filtroAno">
                            <option value="">Todos os Anos</option>
                            {% for ano in range(2026, 2021, -1) %}
                            <option value="{{ ano }}" 
                                    {% if request.args.get('ano_precatorio') == ano|string %}selected{% endif %}>
                                {{ ano }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Valor Mínimo -->
                    <div class="col-md-2">
                        <label class="form-label">
                            <i class="fas fa-dollar-sign me-1"></i>
                            <strong>Valor Mínimo</strong>
                        </label>
                        <input type="number" class="form-control" 
                               name="valor_min" 
                               placeholder="Ex: 100000"
                               step="1000"
                               value="{{ request.args.get('valor_min', '') }}">
                    </div>
                    
                    <!-- Valor Máximo -->
                    <div class="col-md-2">
                        <label class="form-label">
                            <i class="fas fa-dollar-sign me-1"></i>
                            <strong>Valor Máximo</strong>
                        </label>
                        <input type="number" class="form-control" 
                               name="valor_max" 
                               placeholder="Ex: 5000000"
                               step="1000"
                               value="{{ request.args.get('valor_max', '') }}">
                    </div>
                    
                    <!-- Tem Ofício -->
                    <div class="col-md-2">
                        <label class="form-label">
                            <i class="fas fa-file-pdf me-1"></i>
                            <strong>Ofício Expedido</strong>
                        </label>
                        <select class="form-select" name="tem_oficio">
                            <option value="">Todos</option>
                            <option value="sim" {% if request.args.get('tem_oficio') == 'sim' %}selected{% endif %}>
                                Sim
                            </option>
                            <option value="nao" {% if request.args.get('tem_oficio') == 'nao' %}selected{% endif %}>
                                Não
                            </option>
                        </select>
                    </div>
                    
                    <!-- Prioridade -->
                    <div class="col-md-2">
                        <label class="form-label">
                            <i class="fas fa-exclamation-circle me-1"></i>
                            <strong>Prioridade</strong>
                        </label>
                        <select class="form-select" name="prioritario">
                            <option value="">Todos</option>
                            <option value="sim" {% if request.args.get('prioritario') == 'sim' %}selected{% endif %}>
                                Prioritários
                            </option>
                            <option value="nao" {% if request.args.get('prioritario') == 'nao' %}selected{% endif %}>
                                Comuns
                            </option>
                        </select>
                    </div>
                    
                    <!-- Situação de Pagamento -->
                    <div class="col-md-2">
                        <label class="form-label">
                            <i class="fas fa-money-check-alt me-1"></i>
                            <strong>Situação de Pagamento</strong>
                        </label>
                        <select class="form-select" name="situacao_pagamento" id="filtroSituacaoPagamento">
                            <option value="">Todas as Situações</option>
                            <option value="com_pendencia" {% if request.args.get('situacao_pagamento') == 'com_pendencia' %}selected{% endif %}>
                                Com Pendência
                            </option>
                            <option value="pronto_nao_pago" {% if request.args.get('situacao_pagamento') == 'pronto_nao_pago' %}selected{% endif %}>
                                Pronto e Não Pago
                            </option>
                            <option value="pago" {% if request.args.get('situacao_pagamento') == 'pago' %}selected{% endif %}>
                                Pago
                            </option>
                        </select>
                    </div>
                    
                </div>
                
                <!-- Botões de Ação -->
                <div class="row mt-4">
                    <div class="col-12">
                        <hr>
                        <div class="d-flex justify-content-between">
                            <a href="/processos" class="btn btn-secondary">
                                <i class="fas fa-eraser me-2"></i>
                                Limpar Filtros
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-search me-2"></i>
                                Buscar Processos
                            </button>
                        </div>
                    </div>
                </div>
                
            </form>
        </div>
    </div>
</div>

<!-- Estatísticas dos Resultados -->
<div class="row mb-3">
    <div class="col-md-2">
        <div class="card border-primary">
            <div class="card-body text-center">
                <h6 class="text-muted mb-1">Total</h6>
                <h3 class="mb-0 text-primary">{{ total }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card border-success">
            <div class="card-body text-center">
                <h6 class="text-muted mb-1">Valor Total</h6>
                <h4 class="mb-0 text-success">
                    R$ {{ "{:,.0f}".format(valor_total).replace(',', '.') }}
                </h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card border-info">
            <div class="card-body text-center">
                <h6 class="text-muted mb-1">Com Ofício</h6>
                <h3 class="mb-0 text-info">{{ com_oficio }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card border-warning">
            <div class="card-body text-center">
                <h6 class="text-muted mb-1">Com Pendência</h6>
                <h3 class="mb-0 text-warning">{{ com_pendencia }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card border-primary">
            <div class="card-body text-center">
                <h6 class="text-muted mb-1">Pronto Não Pago</h6>
                <h3 class="mb-0 text-primary">{{ pronto_nao_pago }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card border-success">
            <div class="card-body text-center">
                <h6 class="text-muted mb-1">Pagos</h6>
                <h3 class="mb-0 text-success">{{ pagos }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Resultados -->
<div class="card shadow-sm">
    <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>
                Resultados: {{ total }} processo(s)
            </h5>
            <div>
                <select class="form-select form-select-sm" id="ordenacao" onchange="ordenarResultados()">
                    <option value="data_cadastro_desc" {% if request.args.get('ordenar') == 'data_cadastro' and request.args.get('ordem') == 'desc' %}selected{% endif %}>
                        Mais Recentes
                    </option>
                    <option value="data_cadastro_asc" {% if request.args.get('ordenar') == 'data_cadastro' and request.args.get('ordem') == 'asc' %}selected{% endif %}>
                        Mais Antigos
                    </option>
                    <option value="valor_desc" {% if request.args.get('ordenar') == 'valor' and request.args.get('ordem') == 'desc' %}selected{% endif %}>
                        Maior Valor
                    </option>
                    <option value="valor_asc" {% if request.args.get('ordenar') == 'valor' and request.args.get('ordem') == 'asc' %}selected{% endif %}>
                        Menor Valor
                    </option>
                    <option value="credor_asc" {% if request.args.get('ordenar') == 'credor' and request.args.get('ordem') == 'asc' %}selected{% endif %}>
                        Credor (A-Z)
                    </option>
                </select>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead class="table-dark">
                    <tr>
                        <th width="15%">Processo</th>
                        <th width="9%">Tribunal</th>
                        <th width="7%">Esfera</th>
                        <th width="16%">Credor</th>
                        <th width="11%">Valor</th>
                        <th width="8%">Natureza</th>
                        <th width="14%">Status</th>
                        <th width="11%">Situação Pagamento</th>
                        <th width="5%">Ano</th>
                        <th width="4%">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% if processos %}
                        {% for processo in processos %}
                        <tr onclick="window.location='/processo/{{ processo.id }}'" style="cursor: pointer;">
                            <td>
                                <strong>{{ processo.numero_processo }}</strong>
                                {% if processo.processo_principal %}
                                <br>
                                <small class="text-muted">
                                    <i class="fas fa-link me-1"></i>
                                    {{ processo.processo_principal[:18] }}...
                                </small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-info">{{ processo.tribunal.value }}</span>
                            </td>
                            <td>
                                <span class="badge bg-{{ 'primary' if processo.esfera.name == 'FEDERAL' else 'secondary' if processo.esfera.name == 'ESTADUAL' else 'dark' }}">
                                    {{ processo.esfera.value[:3] }}
                                </span>
                            </td>
                            <td>
                                {{ processo.credor_nome[:28] }}
                                {% if processo.credor_idoso or processo.credor_doenca_grave or processo.credor_deficiente %}
                                <br>
                                <small>
                                    {% if processo.credor_idoso %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="fas fa-user-clock"></i>
                                    </span>
                                    {% endif %}
                                    {% if processo.credor_doenca_grave %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-heartbeat"></i>
                                    </span>
                                    {% endif %}
                                    {% if processo.credor_deficiente %}
                                    <span class="badge bg-info">
                                        <i class="fas fa-wheelchair"></i>
                                    </span>
                                    {% endif %}
                                </small>
                                {% endif %}
                            </td>
                            <td>
                                <strong class="text-success">
                                    R$ {{ "{:,.0f}".format(processo.valor_atualizado).replace(',', '.') }}
                                </strong>
                            </td>
                            <td>
                                <span class="badge bg-{{ 'danger' if processo.natureza.name == 'ALIMENTAR' else 'success' if processo.natureza.name == 'TRIBUTARIO' else 'secondary' }}">
                                    {{ processo.natureza.value[:4] }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if processo.status.name == 'CONCLUIDO' or processo.status.name == 'PAGO' else 'info' if processo.status.name == 'VALIDADO' else 'warning' }}">
                                    {{ processo.status.value[:12] }}
                                </span>
                                {% if processo.tem_oficio %}
                                <br>
                                <small>
                                    <span class="badge bg-success">
                                        <i class="fas fa-file-pdf"></i>
                                    </span>
                                </small>
                                {% endif %}
                            </td>
                            <td>
                                {% if processo.status.name == 'PAGO' %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Pago
                                    </span>
                                {% elif not processo.possui_pendencia_pagamento and processo.status.name != 'PAGO' %}
                                    <span class="badge bg-primary">
                                        <i class="fas fa-hourglass-half me-1"></i>
                                        Pronto
                                    </span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="fas fa-clock me-1"></i>
                                        Pendente
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if processo.ano_precatorio %}
                                <strong>{{ processo.ano_precatorio }}</strong>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="/processo/{{ processo.id }}" class="btn btn-sm btn-primary" onclick="event.stopPropagation()">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="10" class="text-center py-5">
                                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Nenhum processo encontrado</h5>
                                <p class="text-muted">Tente ajustar os filtros de busca</p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Paginação -->
    {% if total_paginas > 1 %}
    <div class="card-footer">
        <nav>
            <ul class="pagination justify-content-center mb-0">
                {% if pagina > 1 %}
                <li class="page-item">
                    <a class="page-link" href="?pagina={{ pagina - 1 }}&{{ request.query_string.decode() }}">
                        Anterior
                    </a>
                </li>
                {% endif %}
                
                {% for p in range(1, total_paginas + 1) %}
                    {% if p == pagina %}
                    <li class="page-item active">
                        <span class="page-link">{{ p }}</span>
                    </li>
                    {% elif p <= 3 or p > total_paginas - 3 or (p >= pagina - 1 and p <= pagina + 1) %}
                    <li class="page-item">
                        <a class="page-link" href="?pagina={{ p }}&{{ request.query_string.decode() }}">
                            {{ p }}
                        </a>
                    </li>
                    {% elif p == 4 or p == total_paginas - 3 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                {% endfor %}
                
                {% if pagina < total_paginas %}
                <li class="page-item">
                    <a class="page-link" href="?pagina={{ pagina + 1 }}&{{ request.query_string.decode() }}">
                        Próxima
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<!-- Atalhos de Filtros Rápidos -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    Filtros Rápidos
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <a href="/processos?natureza=ALIMENTAR" class="btn btn-outline-danger">
                        <i class="fas fa-utensils me-1"></i>
                        Alimentares
                    </a>
                    <a href="/processos?natureza=TRIBUTARIO" class="btn btn-outline-success">
                        <i class="fas fa-coins me-1"></i>
                        Tributários
                    </a>
                    <a href="/processos?tem_oficio=sim" class="btn btn-outline-info">
                        <i class="fas fa-file-pdf me-1"></i>
                        Com Ofício
                    </a>
                    <a href="/processos?prioritario=sim" class="btn btn-outline-warning">
                        <i class="fas fa-star me-1"></i>
                        Prioritários
                    </a>
                    <a href="/processos?esfera=FEDERAL" class="btn btn-outline-primary">
                        <i class="fas fa-flag me-1"></i>
                        Federais
                    </a>
                    <a href="/processos?esfera=ESTADUAL" class="btn btn-outline-secondary">
                        <i class="fas fa-map-marker-alt me-1"></i>
                        Estaduais
                    </a>
                    <a href="/processos?valor_min=1000000" class="btn btn-outline-success">
                        <i class="fas fa-dollar-sign me-1"></i>
                        Acima de R$ 1 Mi
                    </a>
                    <a href="/processos?situacao_pagamento=com_pendencia" class="btn btn-outline-warning">
                        <i class="fas fa-clock me-1"></i>
                        Com Pendência
                    </a>
                    <a href="/processos?situacao_pagamento=pronto_nao_pago" class="btn btn-outline-primary">
                        <i class="fas fa-hourglass-half me-1"></i>
                        Pronto e Não Pago
                    </a>
                    <a href="/processos?situacao_pagamento=pago" class="btn btn-outline-success">
                        <i class="fas fa-check-circle me-1"></i>
                        Pagos
                    </a>
                    <a href="/processos?ano_precatorio=2026" class="btn btn-outline-info">
                        <i class="fas fa-calendar me-1"></i>
                        Ano 2026
                    </a>
                    <a href="/processos?ano_precatorio=2025" class="btn btn-outline-info">
                        <i class="fas fa-calendar me-1"></i>
                        Ano 2025
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function ordenarResultados() {
    const select = document.getElementById('ordenacao');
    const valor = select.value;
    const [campo, ordem] = valor.split('_');
    
    const url = new URL(window.location);
    url.searchParams.set('ordenar', campo);
    url.searchParams.set('ordem', ordem === 'desc' ? 'desc' : 'asc');
    
    window.location = url.toString();
}
</script>
{% endblock %}
